<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Movie Graph Query Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; }
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin:12px 0}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    select,input,button{border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0b1220;color:var(--text)}
    select,input{padding:10px 12px;font-size:14px;width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    button{padding:10px 14px;font-weight:600;cursor:pointer;background:linear-gradient(120deg,#22d3ee,#06b6d4);border:none;color:#001018}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border-radius:12px;padding:12px;overflow:auto}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:#a5b4fc}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Movie Graph Query Console</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>API Base URL</label>
          <input id="baseUrl" value="{{ base_url }}">
        </div>
        <div>
          <label>Choose endpoint</label>
          <select id="endpoint">
            {% for e in endpoints %}
              <option value="{{ e }}">{{ e }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="align-self:end">
          <button id="runBtn">Send</button>
        </div>
      </div>

      <!-- path params & query params -->
      <div id="paramForm"></div>

      <!-- POST body form -->
      <div id="bodyForm" style="margin-top:12px; display:none;"></div>

      <div class="muted" id="reqPreview" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <strong>Response</strong>
      <div id="tableWrap" style="display:none; margin-top:8px"></div>
      <pre id="out" style="margin-top:8px"></pre>
    </div>
  </div>

<script>
const ALL_ENDPOINTS = [
  // GET
  "GET /movie/:title",
  "GET /movies",
  "GET /movie/:title/reviews",
  "GET /movies/director/:fullname",
  "GET /movies/actor/:fullname",
  "GET /movies/genre/:genre",
  "GET /user/:username",
  "GET /user/:username/watchlist",
  "GET /user/:username/reviews",
  "GET /user/:username/friends",
  "GET /user/:username/friends/network/:degree",
  "GET /user/:username/movies/hottest",
  "GET /user/:username/movies/recommendations",
  "GET /reviews/:keyword",

  // POST
  "POST /movie/new",
  "POST /movie/genres/new",
  "POST /friends/new",
];

/**
 * For each endpoint, describe:
 *  - path params (to interpolate into :segments)
 *  - and for POST: the JSON body shape
 * For list fields, set list:true (we'll split by comma).
 */
const endpointSpec = {
  // GETs (path params only)
  "GET /movie/:title":                { path:[{key:"title",  label:"Title"}] },
  "GET /movies":                      { path:[] },
  "GET /movie/:title/reviews":        { path:[{key:"title",  label:"Title"}] },
  "GET /movies/director/:fullname":   { path:[{key:"fullname",label:"Director full name"}] },
  "GET /movies/actor/:fullname":      { path:[{key:"fullname",label:"Actor full name"}] },
  "GET /movies/genre/:genre":         { path:[{key:"genre",  label:"Genre"}] },
  "GET /user/:username":              { path:[{key:"username",label:"Username"}] },
  "GET /user/:username/watchlist":    { path:[{key:"username",label:"Username"}] },
  "GET /user/:username/reviews":      { path:[{key:"username",label:"Username"}] },
  "GET /user/:username/friends":      { path:[{key:"username",label:"Username"}] },
  "GET /user/:username/friends/network/:degree": {
    path:[{key:"username",label:"Username"}, {key:"degree",label:"Degree (1â€“5)"}]
  },
  "GET /user/:username/movies/hottest":         { path:[{key:"username",label:"Username"}] },
  "GET /user/:username/movies/recommendations": { path:[{key:"username",label:"Username"}] },
  "GET /reviews/:keyword":            { path:[{key:"keyword",label:"Keyword"}] },

  // POSTs (no path params; JSON body below)
  "POST /movie/new": {
    path:[],
    body:[
      {key:"movieId",     label:"movieId (e.g., tt2395427)"},
      {key:"title",       label:"title"},
      {key:"releaseYear", label:"releaseYear (int)"}
    ]
  },
  "POST /movie/genres/new": {
    path:[],
    body:[
      {key:"title",  label:"title"},
      {key:"genres", label:"genres (comma-separated)", list:true}
    ]
  },
  "POST /friends/new": {
    path:[],
    body:[
      {key:"username1", label:"username1"},
      {key:"username2", label:"username2"}
    ]
  },
};

/** Build a URL path by replacing :params */
function buildPath(template, params) {
  return template.replace(/:([a-zA-Z_]+)/g, (_, k) => encodeURIComponent(params[k] || ""));
}

/** Read form inputs into an object */
function readFields(container, spec) {
  const obj = {};
  (spec || []).forEach(f => {
    const v = (container.querySelector(`#f_${f.key}`)?.value || "").trim();
    obj[f.key] = f.list ? (v ? v.split(",").map(s=>s.trim()).filter(Boolean) : []) : v;
  });
  return obj;
}

/** Render inputs for path params and POST body */
const endpointSel = document.getElementById("endpoint");
const paramForm   = document.getElementById("paramForm");
const bodyForm    = document.getElementById("bodyForm");
const out         = document.getElementById("out");
const tableWrap   = document.getElementById("tableWrap");
const baseUrlEl   = document.getElementById("baseUrl");
const reqPreview  = document.getElementById("reqPreview");

function renderForms() {
  const ep = endpointSel.value;
  const spec = endpointSpec[ep] || {};
  // Path params
  paramForm.innerHTML = "";
  (spec.path || []).forEach(f => {
    const div = document.createElement("div");
    div.style.marginTop = "8px";
    div.innerHTML = `<label>${f.label}</label><input id="f_${f.key}" type="text">`;
    paramForm.appendChild(div);
  });
  // Body params (POST only)
  if (ep.startsWith("POST ")) {
    bodyForm.style.display = "block";
    bodyForm.innerHTML = "<hr style='border-color:rgba(255,255,255,.08)'><strong>JSON body</strong>";
    (spec.body || []).forEach(f => {
      const div = document.createElement("div");
      div.style.marginTop = "8px";
      div.innerHTML = `<label>${f.label}</label><input id="f_${f.key}" type="text">`;
      bodyForm.appendChild(div);
    });
  } else {
    bodyForm.style.display = "none";
    bodyForm.innerHTML = "";
  }
  reqPreview.textContent = "";
}
endpointSel.addEventListener("change", renderForms);
renderForms();

/** Send request */
document.getElementById("runBtn").addEventListener("click", async () => {
  out.textContent = ""; tableWrap.style.display = "none"; tableWrap.innerHTML = "";
  const ep = endpointSel.value;
  const [method, pathTpl] = ep.split(" ");
  const spec = endpointSpec[ep] || {};
  const pathParams = readFields(paramForm, spec.path);
  const url = baseUrlEl.value.replace(/\/$/,"") + buildPath(pathTpl, pathParams);

  let fetchOpts = { method, headers:{} };
  if (method === "POST") {
    const bodyObj = readFields(bodyForm, spec.body);
    fetchOpts.headers["Content-Type"] = "application/json";
    fetchOpts.body = JSON.stringify(bodyObj);
  }

  reqPreview.textContent = `${method} ${url}` + (fetchOpts.body ? `  BODY: ${fetchOpts.body}` : "");

  try {
    const res = await fetch(url, fetchOpts);
    const data = await res.json();
    renderData(data);
  } catch (e) {
    out.textContent = "Error: " + (e?.message || e);
  }
});

/** Render the data */
function renderData(data) {
  const arr = Array.isArray(data) ? data : (data && data.results) || null;
  if (Array.isArray(arr) && arr.length && typeof arr[0] === "object") {
    const keys = Array.from(arr.reduce((s,o)=>{Object.keys(o).forEach(k=>s.add(k));return s;}, new Set()));
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    keys.forEach(k => { const th = document.createElement("th"); th.textContent = k; trh.appendChild(th); });
    thead.appendChild(trh); table.appendChild(thead);
    const tbody = document.createElement("tbody");
    arr.forEach(row => {
      const tr = document.createElement("tr");
      keys.forEach(k => {
        const td = document.createElement("td");
        let v = row[k];
        if (typeof v === "object") v = JSON.stringify(v);
        td.textContent = v !== undefined ? v : "";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    tableWrap.style.display = "block";
    tableWrap.appendChild(table);
    out.textContent = JSON.stringify(arr, null, 2);
  } else {
    out.textContent = JSON.stringify(data, null, 2);
  }
}
</script>
</body>
</html>
